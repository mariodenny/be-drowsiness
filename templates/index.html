<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drowsiness Detection Dashboard</title>
    <style>
        /* CSS sama seperti sebelumnya */
    </style>
</head>
<body>
    <div class="container">
        <!-- Header sama -->
        
        <div class="stats-grid" id="stats">
            <!-- Stats cards sama -->
        </div>

        <div class="stream-section">
            <div class="alerts-header">
                <h2>üìπ Live Camera Streams</h2>
                <div class="live-indicator">
                    <span class="refresh-indicator"></span>
                    Live Stream
                </div>
            </div>
            
            <div id="streamsContainer" class="streams-grid">
                <div class="loading">Loading streams...</div>
            </div>
        </div>

        <div class="alerts-section">
            <!-- Alerts section sama -->
        </div>
    </div>

    <script>
        const VPS_URL = "https://drowsiness.coreva.web.id"; 
        
        // Load and display streams from VPS
        async function loadStreams() {
            try {
                const response = await fetch(`${VPS_URL}/api/stream/list`);
                const data = await response.json();
                
                const container = document.getElementById('streamsContainer');
                
                if (!data.streams || data.streams.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìπ</div>
                            <div>No active streams</div>
                            <small>ESP32 cameras will appear here when connected</small>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = data.streams.map(stream => `
                    <div class="stream-card" id="stream-${stream.esp32_id}">
                        <div class="stream-header">
                            <h3>${stream.esp32_id}</h3>
                            <span class="status-badge ${stream.is_active ? 'status-active' : 'status-inactive'}">
                                <span class="status-dot ${stream.is_active ? 'status-active' : 'status-inactive'}"></span>
                                ${stream.is_active ? 'LIVE' : 'OFFLINE'}
                            </span>
                        </div>
                        <div class="stream-video">
                            <img src="${VPS_URL}/api/stream/${stream.esp32_id}" 
                                 alt="Live Stream"
                                 id="stream-img-${stream.esp32_id}"
                                 onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjMmQyZDJkIi8+PHRleHQgeD0iMjAwIiB5PSIxNTAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgYWxpZ25tZW50LWJhc2VsaW5lPSJtaWRkbGUiPkNhbWVyYSBPZmZsaW5lPC90ZXh0Pjwvc3ZnPg=='">
                        </div>
                        <div class="stream-status">
                            <div>
                                <span class="status-dot ${stream.is_active ? 'status-active' : 'status-inactive'}"></span>
                                <span id="stream-status-${stream.esp32_id}">
                                    ${stream.queue_size || 0} frames
                                </span>
                            </div>
                            <div id="drowsy-status-${stream.esp32_id}">
                                <span class="status-dot status-inactive"></span>
                                AWAKE
                            </div>
                        </div>
                        <div class="stream-controls">
                            <button onclick="refreshStream('${stream.esp32_id}')">üîÑ Refresh</button>
                            <button onclick="viewStreamDetails('${stream.esp32_id}')">üîç Details</button>
                            <button onclick="captureSnapshot('${stream.esp32_id}')">üì∏ Snapshot</button>
                        </div>
                    </div>
                `).join('');
                
                // Auto-refresh stream images
                data.streams.forEach(stream => {
                    if (stream.is_active) {
                        startStreamRefresh(stream.esp32_id);
                    }
                });
                
            } catch (error) {
                console.error('Error loading streams:', error);
                const container = document.getElementById('streamsContainer');
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div>Error loading streams</div>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }
        
        // Auto-refresh stream image
        function startStreamRefresh(esp32Id) {
            setInterval(() => {
                updateStreamImage(esp32Id);
            }, 2000);
        }
        
        function updateStreamImage(esp32Id) {
            const img = document.getElementById(`stream-img-${esp32Id}`);
            if (img) {
                const currentSrc = img.src.split('?')[0];
                img.src = `${currentSrc}?t=${Date.now()}`;
            }
        }
        
        async function fetchStreamStatus(esp32Id) {
            try {
                const response = await fetch(`${VPS_URL}/api/stream/status/${esp32Id}`);
                const status = await response.json();
                
                const statusElement = document.getElementById(`stream-status-${esp32Id}`);
                const drowsyElement = document.getElementById(`drowsy-status-${esp32Id}`);
                const card = document.getElementById(`stream-${esp32Id}`);
                
                if (statusElement && status) {
                    statusElement.textContent = `${status.queue_size || 0} frames`;
                }
                
                if (drowsyElement && status) {
                    if (status.is_drowsy) {
                        drowsyElement.innerHTML = `<span class="status-dot status-drowsy"></span> DROWSY ‚ö†Ô∏è`;
                        if (card) {
                            card.style.boxShadow = '0 0 15px rgba(245, 101, 101, 0.5)';
                            showDrowsyAlert(esp32Id);
                        }
                    } else {
                        drowsyElement.innerHTML = `<span class="status-dot status-active"></span> AWAKE ‚úÖ`;
                        if (card) {
                            card.style.boxShadow = '';
                        }
                    }
                }
            } catch (error) {
                console.error(`Error fetching status for ${esp32Id}:`, error);
            }
        }
        
        function refreshStream(esp32Id) {
            updateStreamImage(esp32Id);
            fetchStreamStatus(esp32Id);
        }
        
        function viewStreamDetails(esp32Id) {
            window.open(`${VPS_URL}/api/stream/${esp32Id}`, '_blank');
        }
        
        async function captureSnapshot(esp32Id) {
            try {
                const response = await fetch(`${VPS_URL}/api/stream/capture/${esp32Id}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `snapshot-${esp32Id}-${Date.now()}.jpg`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    alert('Snapshot captured!');
                }
            } catch (error) {
                console.error('Error capturing snapshot:', error);
                alert('Failed to capture snapshot');
            }
        }
        
        function showDrowsyAlert(esp32Id) {
            const alert = document.createElement('div');
            alert.className = 'alert-item critical';
            alert.innerHTML = `
                <div class="alert-icon">üö®</div>
                <div class="alert-content">
                    <div class="alert-driver">
                        ${esp32Id}
                        <span class="status-badge status-drowsy">DROWSY</span>
                    </div>
                    <div class="alert-details">
                        Drowsiness detected! Immediate attention required.
                    </div>
                </div>
                <div class="alert-time">
                    ${new Date().toLocaleTimeString()}
                </div>
            `;
            
            const alertsList = document.getElementById('alertsList');
            if (alertsList) {
                alertsList.prepend(alert);
                
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.remove();
                    }
                }, 30000);
            }
        }
        
        // Load active devices
        async function loadActiveDevices() {
            try {
                const response = await fetch(`${VPS_URL}/api/active-devices`);
                const devices = await response.json();
                
                const cameraFilter = document.getElementById('cameraFilter');
                cameraFilter.innerHTML = '<option value="">All Cameras</option>';
                
                if (devices && devices.length > 0) {
                    devices.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device.esp32_id;
                        option.textContent = `${device.esp32_id} (${device.is_drowsy ? 'DROWSY' : 'ACTIVE'})`;
                        cameraFilter.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading active devices:', error);
            }
        }
        
        // Load stats
        async function loadStats() {
            try {
                const response = await fetch(`${VPS_URL}/api/stats`);
                const data = await response.json();
                
                document.getElementById('totalDrivers').textContent = data.total_drivers || 0;
                document.getElementById('alertsToday').textContent = data.alerts_today || 0;
                document.getElementById('alertsWeek').textContent = data.alerts_week || 0;
                document.getElementById('criticalToday').textContent = data.critical_today || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        // Load alerts
        async function loadAlerts() {
            try {
                const response = await fetch(`${VPS_URL}/api/alerts?limit=10`);
                const data = await response.json();
                
                const alertsList = document.getElementById('alertsList');
                
                if (!data.alerts || data.alerts.length === 0) {
                    alertsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <div>No alerts yet. System is monitoring...</div>
                        </div>
                    `;
                    return;
                }
                
                alertsList.innerHTML = data.alerts.map(alert => {
                    const isCritical = alert.status === 'DROWSY';
                    const isWarning = alert.status === 'YAWNING';
                    const icon = isCritical ? 'üö®' : (isWarning ? '‚ö†Ô∏è' : '‚úÖ');
                    const criticalClass = isCritical ? 'critical' : (isWarning ? 'warning' : '');
                    const statusClass = alert.status.toLowerCase().replace(' ', '-');
                    
                    const alertTime = new Date(alert.alert_time);
                    const formattedTime = alertTime.toLocaleString('id-ID', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    return `
                        <div class="alert-item ${criticalClass}">
                            <div class="alert-icon">${icon}</div>
                            <div class="alert-content">
                                <div class="alert-driver">
                                    ${alert.driver_name || 'Unknown Driver'}
                                    <span class="status-badge status-${statusClass}">${alert.status}</span>
                                </div>
                                <div class="alert-details">
                                    Camera: ${alert.esp32_id || 'N/A'} | 
                                    Confidence: ${(alert.confidence * 100).toFixed(1)}%
                                </div>
                            </div>
                            <div class="alert-time">
                                ${formattedTime}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading alerts:', error);
                const alertsList = document.getElementById('alertsList');
                alertsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div>Error loading alerts</div>
                    </div>
                `;
            }
        }
        
        // Auto-refresh
        setInterval(() => {
            loadStats();
            loadAlerts();
            loadActiveDevices();
            
            // Refresh stream statuses
            const streamCards = document.querySelectorAll('.stream-card');
            streamCards.forEach(card => {
                const esp32Id = card.id.replace('stream-', '');
                fetchStreamStatus(esp32Id);
            });
        }, 10000);
        
        // Initial load
        loadStreams();
        loadStats();
        loadAlerts();
        loadActiveDevices();
        
        // Camera filter
        document.getElementById('cameraFilter').addEventListener('change', function(e) {
            const selectedCamera = e.target.value;
            const alerts = document.querySelectorAll('.alert-item');
            alerts.forEach(alert => {
                const cameraText = alert.querySelector('.alert-details').textContent;
                if (selectedCamera && cameraText.includes(selectedCamera)) {
                    alert.style.display = 'flex';
                } else if (!selectedCamera) {
                    alert.style.display = 'flex';
                } else {
                    alert.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>