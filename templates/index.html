<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drowsiness Detection Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-links a {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: 0.3s;
            font-weight: 500;
        }

        .nav-links a:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .alerts-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .alerts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .alerts-header h2 {
            color: #333;
        }

        .alert-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-left: 4px solid #667eea;
            background: #f7fafc;
            margin-bottom: 10px;
            border-radius: 5px;
            transition: 0.3s;
        }

        .alert-item:hover {
            background: #edf2f7;
            transform: translateX(5px);
        }

        .alert-item.critical {
            border-left-color: #f56565;
            background: #fff5f5;
        }

        .alert-item.warning {
            border-left-color: #ed8936;
            background: #fffaf0;
        }

        .alert-icon {
            font-size: 32px;
            margin-right: 15px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-driver {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .alert-details {
            font-size: 14px;
            color: #666;
        }

        .alert-time {
            font-size: 12px;
            color: #999;
            text-align: right;
            min-width: 150px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }

        .status-drowsy {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-alert {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-yawning {
            background: #feebc8;
            color: #7c2d12;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 10px;
        }

        .refresh-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #48bb78;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }

        .live-indicator {
            display: flex;
            align-items: center;
            color: #48bb78;
            font-size: 14px;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Stream Styles */
        .stream-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .streams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stream-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .stream-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }

        .stream-header {
            background: #667eea;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stream-video {
            width: 100%;
            height: 300px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            overflow: hidden;
        }

        .stream-video img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .stream-status {
            padding: 15px;
            background: #f7fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-active { background: #48bb78; }
        .status-inactive { background: #a0aec0; }
        .status-drowsy { 
            background: #f56565; 
            animation: pulse 1.5s infinite; 
        }

        .stream-controls {
            padding: 15px;
            background: #f7fafc;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .stream-controls button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: 0.3s;
        }

        .stream-controls button:hover {
            background: #5568d3;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
            }

            .alert-item {
                flex-direction: column;
                text-align: center;
            }

            .alert-time {
                text-align: center;
                margin-top: 10px;
            }

            .alert-icon {
                margin-right: 0;
                margin-bottom: 10px;
            }

            .streams-grid {
                grid-template-columns: 1fr;
            }

            .stream-video {
                height: 250px;
            }
        }
    </style>
    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üöó Drowsiness Detection Dashboard</h1>
            <div class="nav-links">
                <a href="/admin">üë• Drivers</a>
                <a href="/reports">üìã Reports</a>
            </div>
        </div>

        <div class="stats-grid" id="stats">
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-value" id="totalDrivers">-</div>
                <div class="stat-label">Total Drivers</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üö®</div>
                <div class="stat-value" id="alertsToday">-</div>
                <div class="stat-label">Alerts Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-value" id="alertsWeek">-</div>
                <div class="stat-label">Alerts This Week</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚ö†Ô∏è</div>
                <div class="stat-value" id="criticalToday">-</div>
                <div class="stat-label">Critical Today</div>
            </div>
        </div>

        <div class="stream-section">
            <div class="alerts-header">
                <h2>üìπ Live Camera Streams</h2>
                <div class="live-indicator">
                    <span class="refresh-indicator"></span>
                    Live Stream
                </div>
            </div>
            
            <div id="streamsContainer" class="streams-grid">
                <div class="loading">Loading streams...</div>
            </div>
        </div>

        <div class="alerts-section">
            <div class="alerts-header">
                <h2>üì° Recent Alerts</h2>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <select id="cameraFilter"
                        style="padding: 8px 15px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 14px;">
                        <option value="">All Cameras</option>
                    </select>
                    <div class="live-indicator">
                        <span class="refresh-indicator"></span>
                        Live Updates
                    </div>
                </div>
            </div>

            <!-- Camera Status Cards -->
            <div id="cameraStatus"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
            </div>

            <!-- Alerts List -->
            <div id="alertsList">
                <div class="loading">Loading alerts</div>
            </div>
        </div>
    </div>

    <script>
        const VPS_URL = "http://103.197.188.191:7001";
        
        // Initialize Socket.IO connection
        const socket = io(VPS_URL);
        
        // Socket event handlers
        socket.on('connect', () => {
            console.log('‚úÖ Connected to stream server');
            
            // Subscribe to stream updates
            socket.emit('subscribe_stream', { esp32_id: 'all' });
            
            // Load initial data
            loadStreams();
            loadStats();
            loadAlerts();
            loadActiveDevices();
        });
        
        socket.on('disconnect', () => {
            console.log('‚ùå Disconnected from stream server');
        });
        
        socket.on('frame_update', (data) => {
            console.log('üîÑ Frame update:', data.esp32_id);
            updateStreamImage(data.esp32_id);
            
            // Show alert if drowsy
            if (data.drowsy) {
                showDrowsyAlert(data.esp32_id);
            }
        });
        
        socket.on('stream_status', (data) => {
            updateStreamStatus(data.esp32_id, data);
        });
        
        // Load and display streams from VPS
        async function loadStreams() {
            try {
                const response = await fetch(`${VPS_URL}/api/stream/list`);
                const data = await response.json();
                
                const container = document.getElementById('streamsContainer');
                
                if (!data.streams || data.streams.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìπ</div>
                            <div>No active streams</div>
                            <small>ESP32 cameras will appear here when connected</small>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = data.streams.map(stream => `
                    <div class="stream-card" id="stream-${stream.esp32_id}">
                        <div class="stream-header">
                            <h3>${stream.esp32_id}</h3>
                            <span class="status-badge ${stream.is_active ? 'status-active' : 'status-inactive'}">
                                <span class="status-dot ${stream.is_active ? 'status-active' : 'status-inactive'}"></span>
                                ${stream.is_active ? 'LIVE' : 'OFFLINE'}
                            </span>
                        </div>
                        <div class="stream-video">
                            <img src="${VPS_URL}/api/stream/${stream.esp32_id}" 
                                 alt="Live Stream"
                                 id="stream-img-${stream.esp32_id}"
                                 onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjMmQyZDJkIi8+PHRleHQgeD0iMjAwIiB5PSIxNTAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgYWxpZ25tZW50LWJhc2VsaW5lPSJtaWRkbGUiPkNhbWVyYSBPZmZsaW5lPC90ZXh0Pjwvc3ZnPg=='">
                        </div>
                        <div class="stream-status">
                            <div>
                                <span class="status-dot ${stream.is_active ? 'status-active' : 'status-inactive'}"></span>
                                <span id="stream-status-${stream.esp32_id}">
                                    ${stream.queue_size || 0} frames
                                </span>
                            </div>
                            <div id="drowsy-status-${stream.esp32_id}">
                                <span class="status-dot status-inactive"></span>
                                AWAKE
                            </div>
                        </div>
                        <div class="stream-controls">
                            <button onclick="refreshStream('${stream.esp32_id}')">üîÑ Refresh</button>
                            <button onclick="viewStreamDetails('${stream.esp32_id}')">üîç Details</button>
                            <button onclick="captureSnapshot('${stream.esp32_id}')">üì∏ Snapshot</button>
                        </div>
                    </div>
                `).join('');
                
                // Auto-refresh stream images
                data.streams.forEach(stream => {
                    if (stream.is_active) {
                        startStreamRefresh(stream.esp32_id);
                    }
                });
                
            } catch (error) {
                console.error('Error loading streams:', error);
                const container = document.getElementById('streamsContainer');
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div>Error loading streams</div>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }
        
        // Auto-refresh stream image
        function startStreamRefresh(esp32Id) {
            setInterval(() => {
                updateStreamImage(esp32Id);
            }, 2000); // Refresh every 2 seconds
        }
        
        function updateStreamImage(esp32Id) {
            const img = document.getElementById(`stream-img-${esp32Id}`);
            if (img) {
                // Force refresh by adding timestamp
                const currentSrc = img.src.split('?')[0];
                img.src = `${currentSrc}?t=${Date.now()}`;
            }
        }
        
        function updateStreamStatus(esp32Id, status) {
            const statusElement = document.getElementById(`stream-status-${esp32Id}`);
            const drowsyElement = document.getElementById(`drowsy-status-${esp32Id}`);
            const card = document.getElementById(`stream-${esp32Id}`);
            
            if (statusElement && status) {
                statusElement.textContent = `${status.queue_size || 0} frames | ${status.clients_count || 0} viewers`;
            }
            
            if (drowsyElement && status) {
                if (status.is_drowsy) {
                    drowsyElement.innerHTML = `<span class="status-dot status-drowsy"></span> DROWSY ‚ö†Ô∏è`;
                    if (card) {
                        card.style.boxShadow = '0 0 15px rgba(245, 101, 101, 0.5)';
                    }
                } else {
                    drowsyElement.innerHTML = `<span class="status-dot status-active"></span> AWAKE ‚úÖ`;
                    if (card) {
                        card.style.boxShadow = '';
                    }
                }
            }
        }
        
        function refreshStream(esp32Id) {
            updateStreamImage(esp32Id);
            fetchStreamStatus(esp32Id);
        }
        
        async function fetchStreamStatus(esp32Id) {
            try {
                const response = await fetch(`${VPS_URL}/api/stream/status/${esp32Id}`);
                const status = await response.json();
                updateStreamStatus(esp32Id, status);
            } catch (error) {
                console.error(`Error fetching status for ${esp32Id}:`, error);
            }
        }
        
        function viewStreamDetails(esp32Id) {
            window.open(`${VPS_URL}/api/stream/${esp32Id}`, '_blank');
        }
        
        async function captureSnapshot(esp32Id) {
            try {
                const response = await fetch(`${VPS_URL}/api/stream/capture/${esp32Id}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `snapshot-${esp32Id}-${Date.now()}.jpg`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    alert('Snapshot captured!');
                }
            } catch (error) {
                console.error('Error capturing snapshot:', error);
                alert('Failed to capture snapshot');
            }
        }
        
        function showDrowsyAlert(esp32Id) {
            const alert = document.createElement('div');
            alert.className = 'alert-item critical';
            alert.innerHTML = `
                <div class="alert-icon">üö®</div>
                <div class="alert-content">
                    <div class="alert-driver">
                        ${esp32Id}
                        <span class="status-badge status-drowsy">DROWSY</span>
                    </div>
                    <div class="alert-details">
                        Drowsiness detected! Immediate attention required.
                    </div>
                </div>
                <div class="alert-time">
                    ${new Date().toLocaleTimeString()}
                </div>
            `;
            
            const alertsList = document.getElementById('alertsList');
            if (alertsList) {
                alertsList.prepend(alert);
                
                // Remove after 30 seconds
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.remove();
                    }
                }, 30000);
            }
        }
        
        // Load active devices
        async function loadActiveDevices() {
            try {
                const response = await fetch(`${VPS_URL}/api/active-devices`);
                const devices = await response.json();
                
                const cameraFilter = document.getElementById('cameraFilter');
                cameraFilter.innerHTML = '<option value="">All Cameras</option>';
                
                if (devices && devices.length > 0) {
                    devices.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device.esp32_id;
                        option.textContent = `${device.esp32_id} (${device.is_drowsy ? 'DROWSY' : 'ACTIVE'})`;
                        cameraFilter.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading active devices:', error);
            }
        }
        
        // Load stats from VPS
        async function loadStats() {
            try {
                const response = await fetch(`${VPS_URL}/api/stats`);
                const data = await response.json();
                
                document.getElementById('totalDrivers').textContent = data.total_drivers || 0;
                document.getElementById('alertsToday').textContent = data.alerts_today || 0;
                document.getElementById('alertsWeek').textContent = data.alerts_week || 0;
                document.getElementById('criticalToday').textContent = data.critical_today || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        // Load alerts from VPS
        async function loadAlerts() {
            try {
                const response = await fetch(`${VPS_URL}/api/alerts?limit=10`);
                const data = await response.json();
                
                const alertsList = document.getElementById('alertsList');
                
                if (!data.alerts || data.alerts.length === 0) {
                    alertsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <div>No alerts yet. System is monitoring...</div>
                        </div>
                    `;
                    return;
                }
                
                alertsList.innerHTML = data.alerts.map(alert => {
                    const isCritical = alert.status === 'DROWSY';
                    const isWarning = alert.status === 'YAWNING';
                    const icon = isCritical ? 'üö®' : (isWarning ? '‚ö†Ô∏è' : '‚úÖ');
                    const criticalClass = isCritical ? 'critical' : (isWarning ? 'warning' : '');
                    const statusClass = alert.status.toLowerCase().replace(' ', '-');
                    
                    const alertTime = new Date(alert.alert_time);
                    const formattedTime = alertTime.toLocaleString('id-ID', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    return `
                        <div class="alert-item ${criticalClass}">
                            <div class="alert-icon">${icon}</div>
                            <div class="alert-content">
                                <div class="alert-driver">
                                    ${alert.driver_name || 'Unknown Driver'}
                                    <span class="status-badge status-${statusClass}">${alert.status}</span>
                                </div>
                                <div class="alert-details">
                                    Camera: ${alert.esp32_id || 'N/A'} | 
                                    Confidence: ${(alert.confidence * 100).toFixed(1)}%
                                </div>
                            </div>
                            <div class="alert-time">
                                ${formattedTime}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading alerts:', error);
                const alertsList = document.getElementById('alertsList');
                alertsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div>Error loading alerts. Please check your connection.</div>
                    </div>
                `;
            }
        }
        
        // Auto-refresh functions
        setInterval(() => {
            loadStats();
            loadAlerts();
            loadActiveDevices();
        }, 10000); // Refresh every 10 seconds
        
        // Initial load
        loadStreams();
        loadStats();
        loadAlerts();
        loadActiveDevices();
        
        // Camera filter functionality
        document.getElementById('cameraFilter').addEventListener('change', function(e) {
            const selectedCamera = e.target.value;
            if (selectedCamera) {
                // Filter alerts by camera
                const alerts = document.querySelectorAll('.alert-item');
                alerts.forEach(alert => {
                    const cameraText = alert.querySelector('.alert-details').textContent;
                    if (cameraText.includes(selectedCamera)) {
                        alert.style.display = 'flex';
                    } else {
                        alert.style.display = 'none';
                    }
                });
            } else {
                // Show all alerts
                const alerts = document.querySelectorAll('.alert-item');
                alerts.forEach(alert => {
                    alert.style.display = 'flex';
                });
            }
        });
    </script>
</body>
</html>